name: Integration Tests

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: integration-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  integration:
    name: Backend Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Start all services
        run: |
          echo "Starting docker-compose services..."
          docker compose -f docker-compose-integration.yml up -d --build

          echo "Waiting for services to be healthy..."
          # Wait for all services to be healthy (up to 5 minutes)
          timeout=300
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            # Check if all required services are healthy
            all_healthy=true

            for service in supabase-db users documents knowledge region api; do
              status=$(docker compose -f docker-compose-integration.yml ps --format json | jq -r ".[] | select(.Service==\"$service\") | .Health" 2>/dev/null || echo "unknown")
              if [ "$status" != "healthy" ]; then
                all_healthy=false
                echo "Waiting for $service (status: $status)..."
              fi
            done

            if [ "$all_healthy" = "true" ]; then
              echo "All services are healthy!"
              break
            fi

            sleep 5
            elapsed=$((elapsed + 5))
          done

          if [ $elapsed -ge $timeout ]; then
            echo "ERROR: Services did not become healthy within ${timeout}s"
            docker compose -f docker-compose-integration.yml ps
            docker compose -f docker-compose-integration.yml logs
            exit 1
          fi

          echo "Service status:"
          docker compose -f docker-compose-integration.yml ps

      - name: Run integration tests
        run: |
          docker compose -f docker-compose-integration.yml --profile test run --rm test-runner

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Docker Compose Service Status ==="
          docker compose -f docker-compose-integration.yml ps

          echo ""
          echo "=== API Gateway Logs ==="
          docker compose -f docker-compose-integration.yml logs api --tail=100

          echo ""
          echo "=== Users Service Logs ==="
          docker compose -f docker-compose-integration.yml logs users --tail=100

          echo ""
          echo "=== Documents Service Logs ==="
          docker compose -f docker-compose-integration.yml logs documents --tail=100

          echo ""
          echo "=== Knowledge Service Logs ==="
          docker compose -f docker-compose-integration.yml logs knowledge --tail=100

          echo ""
          echo "=== Region Service Logs ==="
          docker compose -f docker-compose-integration.yml logs region --tail=100

          echo ""
          echo "=== Database Logs ==="
          docker compose -f docker-compose-integration.yml logs supabase-db --tail=50

      - name: Stop all services
        if: always()
        run: docker compose -f docker-compose-integration.yml --profile test down -v